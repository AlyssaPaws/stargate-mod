using RimWorld;
using System.Collections.Generic;
using StargatesMod.Mod_Settings;
using Verse;

namespace StargatesMod
{
    public class PawnsArrivalModeWorker_Stargate : PawnsArrivalModeWorker
    {
        private readonly StargatesMod_Settings _settings = LoadedModManager.GetMod<StargatesMod_Mod>().GetSettings<StargatesMod_Settings>();
        
        public override void Arrive(List<Pawn> pawns, IncidentParms parms)
        {
            Map map = (Map)parms.target;
            Thing stargateOnMap = CompStargate.GetStargateOnMap(map);

            CompStargate sgComp = stargateOnMap.TryGetComp<CompStargate>();
            int lockDelay = 900;
            if (_settings.ShortenGateDialSeq) lockDelay = 450;
            sgComp.OpenStargateDelayed(-1, lockDelay);
            sgComp.TicksSinceBufferUnloaded = -150;
            sgComp.IsReceivingGate = true;
            
            foreach (Pawn pawn in pawns)
            {
                sgComp.AddToReceiveBuffer(pawn);
            }
        }
        public override bool TryResolveRaidSpawnCenter(IncidentParms parms)
        {
            Map map = (Map)parms.target;
            parms.spawnRotation = Rot4.South;
            Thing stargateOnMap = CompStargate.GetStargateOnMap(map);
            CompStargate sgComp = stargateOnMap?.TryGetComp<CompStargate>();
            
            if (stargateOnMap == null || sgComp == null || sgComp.StargateIsActive)
            {
                parms.raidArrivalMode = PawnsArrivalModeDefOf.EdgeWalkIn;
                return parms.raidArrivalMode.Worker.TryResolveRaidSpawnCenter(parms);
            }

            parms.spawnCenter = stargateOnMap.Position;
            return true;
        }
    }
}